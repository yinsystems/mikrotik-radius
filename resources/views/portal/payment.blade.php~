@extends('layouts.portal')

@section('title', 'Payment - WiFi Portal')

@section('content')
<div class="space-y-6">

    <!-- Header -->
    <div class="text-center">
        <div class="w-16 h-16 mx-auto mb-4 flex items-center justify-center">
            <img src="{{ asset('logo/wifi.png') }}" alt="WiFi Logo" class="max-w-full max-h-full object-contain">
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Complete Payment</h2>
        <p class="text-gray-600">Secure payment for your internet package</p>
    </div>

    <!-- Package Summary Card -->
    <div class="bg-white rounded-xl card-shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-box text-blue-600 mr-2"></i>
            Package Summary
        </h3>

        <div class="bg-blue-50 rounded-lg p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
                <h4 class="text-xl font-bold text-gray-900">{{ $package->name }}</h4>
                <div class="text-2xl font-bold text-green-600">
                    GH₵{{ number_format($package->price, 2) }}
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-download text-blue-600"></i>
                    <span class="text-sm text-gray-700">
                                <strong>{{ $package->data_limit_display }}</strong> Data
                            </span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-clock text-blue-600"></i>
                    <span class="text-sm text-gray-700">
                                <strong>{{ $package->duration_display }}</strong>
                            </span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-tachometer-alt text-blue-600"></i>
                    <span class="text-sm text-gray-700">
                                <strong>{{ $package->bandwidth_display }}</strong>
                            </span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-users text-blue-600"></i>
                    <span class="text-sm text-gray-700">
                                <strong>{{ $package->simultaneous_users ?? 'Unlimited' }}</strong> Devices
                            </span>
                </div>
            </div>

            @if($package->description)
                <div class="mt-3 pt-3 border-t border-blue-200">
                    <p class="text-sm text-gray-700">{{ $package->description }}</p>
                </div>
            @endif
        </div>

        <!-- Customer Info -->
        <div class="border-t border-gray-200 pt-4">
            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-600">Phone Number:</span>
                <span class="font-medium">{{ $customer->phone }}</span>
            </div>
        </div>
    </div>

    <!-- Payment Method Card -->
    <div class="bg-white rounded-xl card-shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-credit-card text-green-600 mr-2"></i>
            Payment Method
        </h3>

        <form id="paymentForm" class="space-y-4">
            @csrf
            <input type="hidden" name="package_id" value="{{ $package->id }}">
            <input type="hidden" name="amount" value="{{ $package->price }}">

            <!-- Mobile Money Networks -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    Select Mobile Money Network *
                </label>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors payment-option">
                        <input type="radio" name="network" value="mtn" class="mr-3" required>
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-xs">MTN</span>
                            </div>
                            <span class="font-medium">MTN MoMo</span>
                        </div>
                    </label>

                    <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors payment-option">
                        <input type="radio" name="network" value="VODAFONE" class="mr-3" required>
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-xs">VOD</span>
                            </div>
                            <span class="font-medium">Vodafone Cash</span>
                        </div>
                    </label>

                    <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors payment-option">
                        <input type="radio" name="network" value="AIRTELTIGO" class="mr-3" required>
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-xs">AT</span>
                            </div>
                            <span class="font-medium">AirtelTigo Money</span>
                        </div>
                    </label>

                    <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors payment-option">
                        <input type="radio" name="network" value="VODAFONE" class="mr-3" required>
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-xs">TEL</span>
                            </div>
                            <span class="font-medium">Telecel Cash</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Mobile Money Phone Number -->
            <div>
                <label for="momo_phone" class="block text-sm font-medium text-gray-700 mb-2">
                    Mobile Money Phone Number *
                </label>
                <input type="tel"
                       id="momo_phone"
                       name="momo_phone"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="0244123456"
                       value="{{ $customer->phone }}"
                       oninput="formatPhoneNumber(this)"
                       required>
                <p class="text-xs text-gray-500 mt-1">Enter the phone number registered with your mobile money account</p>
            </div>

            <!-- Payment Terms -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5"></i>
                    <div class="text-sm">
                        <p class="font-medium text-yellow-800 mb-1">Payment Information:</p>
                        <ul class="text-yellow-700 space-y-1 text-xs">
                            <li>• You will receive a mobile money prompt on your phone</li>
                            <li>• Enter your mobile money PIN to approve the payment</li>
                            <li>• Your internet access will be activated automatically upon successful payment</li>
                            <li>• Keep your phone nearby to receive the payment prompt</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Total Amount -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <span class="text-lg font-medium text-gray-900">Total Amount:</span>
                    <span class="text-2xl font-bold text-green-600">GH₵{{ number_format($package->price, 2) }}</span>
                </div>
            </div>

            <!-- Pay Button -->
            <button type="submit"
                    id="payButton"
                    class="w-full bg-green-600 text-white py-4 px-4 rounded-lg font-bold text-lg hover:bg-green-700 transition-colors btn-loading">
                <span class="btn-text flex items-center justify-center space-x-2">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Pay GH₵{{ number_format($package->price, 2) }}</span>
                </span>
                <div class="spinner hidden"></div>
            </button>
        </form>
    </div>

    <!-- Support Card -->
    @if(isset($settings) && ($settings->whatsapp_support_enabled || $settings->company_phone))
        <div class="bg-white rounded-xl card-shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-headset text-purple-600 mr-2"></i>
                Need Help?
            </h3>

            <div class="space-y-3">
                @if($settings->whatsapp_support_enabled)
                    <a href="{{ \App\Helpers\SettingsHelper::getWhatsAppUrl('Need help with payment for ' . $package->name) }}"
                       target="_blank"
                       class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg hover:bg-green-100 transition-colors">
                        <i class="fab fa-whatsapp text-green-600 text-xl"></i>
                        <div>
                            <p class="font-medium text-green-800">WhatsApp Support</p>
                            <p class="text-sm text-green-600">Get instant help via WhatsApp</p>
                        </div>
                    </a>
                @endif

                @if($settings->company_phone)
                    <a href="tel:{{ $settings->company_phone }}"
                       class="flex items-center space-x-3 p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                        <i class="fas fa-phone text-blue-600 text-xl"></i>
                        <div>
                            <p class="font-medium text-blue-800">Call Support</p>
                            <p class="text-sm text-blue-600">{{ $settings->company_phone }}</p>
                        </div>
                    </a>
                @endif
            </div>
        </div>
    @endif

    <!-- Navigation -->
    <div class="flex justify-between items-center pt-4">
        <a href="{{ route('portal.packages') }}"
           class="text-gray-600 hover:text-gray-700 flex items-center space-x-2">
            <i class="fas fa-arrow-left"></i>
            <span>Change Package</span>
        </a>

        <a href="{{ route('portal.logout') }}"
           onclick="event.preventDefault(); document.getElementById('logout-form').submit();"
           class="text-red-600 hover:text-red-700 flex items-center space-x-2">
            <i class="fas fa-sign-out-alt"></i>
            <span>Cancel & Logout</span>
        </a>
    </div>

    <form id="logout-form" action="{{ route('portal.logout') }}" method="POST" class="hidden">
        @csrf
    </form>

</div>

<!-- Payment Status Modal -->
<div id="paymentStatusModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
            <div class="text-center">
                <div id="paymentIcon" class="w-16 h-16 mx-auto mb-4">
                    <!-- Icon will be injected by JavaScript -->
                </div>
                <h3 id="paymentTitle" class="text-lg font-medium text-gray-900 mb-2"></h3>
                <div id="paymentMessage" class="text-gray-600 mb-4"></div>
                <div id="paymentActions" class="space-y-2">
                    <!-- Actions will be injected by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

@endsection

@push('scripts')
<script>
    let paymentCheckInterval;
    let paymentTimeout;

    // Handle payment form submission
    document.getElementById('paymentForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        // Validate form
        if (!data.network) {
            showAlert('Error', 'Please select a mobile money network');
            return;
        }

        if (!data.momo_phone) {
            showAlert('Error', 'Please enter your mobile money phone number');
            return;
        }

        // Validate phone number format
        const phoneRegex = /^0[0-9]{9}$/;
        if (!phoneRegex.test(data.momo_phone)) {
            showAlert('Error', 'Please enter a valid 10-digit phone number starting with 0');
            return;
        }

        initiatePayment(data);
    });

    function initiatePayment(paymentData) {
        showLoading();

        fetch("{{ route('portal.process.payment') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
            },
            body: JSON.stringify(paymentData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();

            if (data.success) {
                // Show payment pending modal
                showPaymentStatus('pending', 'Payment Initiated',
                    'Please check your phone for the mobile money prompt and enter your PIN to complete the payment.');

                // Start checking payment status
                startPaymentStatusCheck(data.payment_id);
            } else {
                if (data.errors) {
                    const errorMessages = Object.values(data.errors).flat().join('\n');
                    showAlert('Validation Error', errorMessages);
                } else {
                    showAlert('Error', data.message);
                }
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showAlert('Error', 'Payment initiation failed. Please try again.');
        });
    }

    function startPaymentStatusCheck(paymentId) {
        let attempts = 0;
        const maxAttempts = 60; // Check for 5 minutes (60 attempts * 5 seconds)

        paymentCheckInterval = setInterval(() => {
            attempts++;

            checkPaymentStatus(paymentId)
                .then(response => {
                    if (response.status === 'completed') {
                        clearInterval(paymentCheckInterval);

                        if (response.router_redirect) {
                            // Show success with router redirect button and credentials
                            const credentials = response.credentials;
                            const credentialsHtml = credentials ?
                                `<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-left">
                                    <h4 class="font-medium text-blue-900 mb-2">Your Internet Login Details:</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between items-center">
                                            <span class="text-blue-700">Username:</span>
                                            <span class="font-mono font-medium">${credentials.username}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-blue-700">Password:</span>
                                            <span class="font-mono font-medium">${credentials.password}</span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-blue-600 mt-2">Use these details to log in at the router page.</p>
                                </div>` : '';

                            showPaymentStatus('success', 'Payment Successful!',
                                'Your payment has been processed successfully. Your internet access is now active!',
                                `${credentialsHtml}
                                <button onclick="redirectToRouter()"
                                        class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                                    <i class="fas fa-wifi mr-2"></i>Connect to Internet
                                </button>`);
                        } else {
                            showPaymentStatus('success', 'Payment Successful!',
                                'Your payment has been processed successfully. Your internet access is being activated...');

                            // Redirect to dashboard after 3 seconds
                            setTimeout(() => {
                                if (response.redirect) {
                                    window.location.href = response.redirect;
                                } else {
                                    window.location.href = "{{ route('portal.dashboard') }}";
                                }
                            }, 3000);
                        }
                    } else if (response.status === 'failed') {
                        clearInterval(paymentCheckInterval);
                        showPaymentStatus('failed', 'Payment Failed',
                            response.message || 'Your payment could not be processed. Please try again or contact support.');
                    }
                    // Continue checking if status is 'processing'
                })
                .catch(error => {
                    console.error('Payment status check error:', error);
                });

            // Timeout after maxAttempts
            if (attempts >= maxAttempts) {
                clearInterval(paymentCheckInterval);
                showPaymentStatus('timeout', 'Payment Timeout',
                    'We could not verify your payment status. Please contact support if money was deducted from your account.');
            }
        }, 5000); // Check every 5 seconds
    }

    function checkPaymentStatus(paymentId) {
        return fetch("{{ route('portal.check.payment.status') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
            },
            body: JSON.stringify({ payment_id: paymentId })
        })
        .then(response => response.json())
        .catch(error => {
            console.error('Status check error:', error);
            return { status: 'error' };
        });
    }

    function showPaymentStatus(status, title, message, customActions = null) {
        const modal = document.getElementById('paymentStatusModal');
        const iconContainer = document.getElementById('paymentIcon');
        const titleElement = document.getElementById('paymentTitle');
        const messageElement = document.getElementById('paymentMessage');
        const actionsElement = document.getElementById('paymentActions');

        // Clear previous content
        iconContainer.innerHTML = '';
        actionsElement.innerHTML = '';

        // Set title and message
        titleElement.textContent = title;
        messageElement.textContent = message;

        // Set icon and actions based on status
        switch (status) {
            case 'pending':
                iconContainer.innerHTML = '<div class="spinner mx-auto"></div>';
                actionsElement.innerHTML = `
                    <button onclick="cancelPayment()"
                            class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        Cancel Payment
                    </button>
                `;
                break;

            case 'success':
                iconContainer.innerHTML = `
                    <div class="w-16 h-16 mx-auto bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check text-3xl text-green-600"></i>
                    </div>
                `;

                // Use custom actions if provided, otherwise default
                if (customActions) {
                    actionsElement.innerHTML = customActions;
                } else {
                    actionsElement.innerHTML = `
                        <button onclick="redirectToRouter()"
                                class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Continue to Internet
                        </button>
                    `;
                }
                break;

            case 'failed':
                iconContainer.innerHTML = `
                    <div class="w-16 h-16 mx-auto bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-times text-3xl text-red-600"></i>
                    </div>
                `;
                actionsElement.innerHTML = `
                    <button onclick="retryPayment()"
                            class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 mb-2">
                        Try Again
                    </button>
                    <button onclick="closePaymentModal()"
                            class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        Cancel
                    </button>
                `;
                break;

            case 'timeout':
                iconContainer.innerHTML = `
                    <div class="w-16 h-16 mx-auto bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-3xl text-yellow-600"></i>
                    </div>
                `;
                actionsElement.innerHTML = `
                    <button onclick="contactSupport()"
                            class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mb-2">
                        Contact Support
                    </button>
                    <button onclick="closePaymentModal()"
                            class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        Close
                    </button>
                `;
                break;
        }

        modal.classList.remove('hidden');
    }

    function closePaymentModal() {
        document.getElementById('paymentStatusModal').classList.add('hidden');
        if (paymentCheckInterval) {
            clearInterval(paymentCheckInterval);
        }
    }

    function cancelPayment() {
        if (paymentCheckInterval) {
            clearInterval(paymentCheckInterval);
        }
        closePaymentModal();
    }

    function retryPayment() {
        closePaymentModal();
        // Reset form and allow user to try again
    }

    function redirectToRouter() {
        // Show loading message
        showPaymentStatus('success', 'Redirecting...',
            'Taking you to the internet login page...',
            `<div class="w-full">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-sm text-gray-600 text-center">Please wait...</p>
            </div>`);

        // Redirect to router login page
        setTimeout(() => {
            // Try to redirect, but provide fallback
            try {
                window.location.href = 'http://192.168.77.1/login';
            } catch (error) {
                // If redirect fails, show instructions with credentials
                const customerPhone = "{{ $customer->phone ?? '' }}";
                showPaymentStatus('success', 'Ready to Connect!',
                    'Your subscription is active. Please navigate to http://192.168.77.1/logout in your browser to connect to the internet.',
                    `<div class="space-y-4">
                        ${customerPhone ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                            <h4 class="font-medium text-blue-900 mb-2">Your Login Details:</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-blue-700">Username:</span>
                                    <span class="font-mono font-medium">${customerPhone}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-blue-700">Password:</span>
                                    <span class="font-mono font-medium">${customerPhone}</span>
                                </div>
                            </div>
                        </div>` : ''}
                        <div class="space-y-2">
                            <button onclick="window.open('http://192.168.77.1/login', '_blank')"
                                    class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                                <i class="fas fa-external-link-alt mr-2"></i>Open Login Page
                            </button>
                            <button onclick="copyLoginUrl()"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                                <i class="fas fa-copy mr-2"></i>Copy Login URL
                            </button>
                        </div>
                    </div>`);
            }
        }, 2000);
    }

    function copyLoginUrl() {
        const url = 'http://192.168.77.1/login';
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(url).then(() => {
                showAlert('Success', 'Login URL copied to clipboard!');
            });
        } else {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            textArea.setSelectionRange(0, 99999);
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showAlert('Success', 'Login URL copied to clipboard!');
        }
    }

    function contactSupport() {
        @if(isset($settings) && $settings->whatsapp_support_enabled)
            window.open("{{ \App\Helpers\SettingsHelper::getWhatsAppUrl('Payment issue for ' . $package->name . ' package') }}", '_blank');
        @else
            showAlert('Support', 'Please contact support for assistance with your payment.');
        @endif
    }

    // Style payment options on selection
    document.querySelectorAll('.payment-option input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('border-blue-500', 'bg-blue-50');
            });

            if (this.checked) {
                this.closest('.payment-option').classList.add('border-blue-500', 'bg-blue-50');
            }
        });
    });
</script>
@endpush
